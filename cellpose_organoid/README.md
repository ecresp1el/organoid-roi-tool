# Cellpose Organoid Pipeline

This folder contains helper scripts that turn the projections generated by
`simple_projection_tool/prepare_for_cellprofiler_cellpose.py` into training data
for Cellpose, produce quick segmentations, and manage the training workspace.
Everything here is written for the “whole organoid = one ROI” use case.

The scripts are designed so scientists can keep the heavy outputs (symlinks,
Cellpose logs, trained models) **outside of the git repository** but still reuse
the shared logic that lives in this folder.

---

## Prerequisites

1. Run the imaging pipeline through the `simple_projection_tool` stage:
   - `simple_channel_projections.py`
   - `run_projection_analysis.py`
   - `prepare_for_cellprofiler_cellpose.py`
2. Confirm the project drive now contains:
   ```
   <project>/cellprofilerandcellpose_folder/
     ├── cellprofilerandcellpose_metadata.csv
     └── cellpose_multichannel_zcyx/
         ├── <analysis>/<projection>/<group>/*.tif
         └── cellpose_multichannel_metadata.csv
   ```
3. Activate the Conda environment that has Cellpose installed
   (e.g. `conda activate cellprofiler_env`).

---

## Key Scripts

| Script | Purpose |
| ------ | ------- |
| `scripts/prepare_training_from_metadata.py` | Reads the metadata CSV and symlinks the selected TIFFs into a training folder. |
| `scripts/make_seg_from_model.py` | Runs a Cellpose model on one or more folders, generating the standard `*_seg.npy` files. |
| `train_organoid_model.sh` | End-to-end pipeline: link training data, generate labels (if missing), train a custom model, and archive the results. |
| `analyse_whole_organoid.py` | Summarise manually curated `_seg.npy` masks (WT vs KO tables/plots) using the multi-channel TIFF stacks. |
| `copy_max_masks.py` | Duplicate masks from the max projection into mean/median folders. |

---

## Whole-organoid quick recipe

1. **Finish the projection export** with
   `simple_projection_tool/prepare_for_cellprofiler_cellpose.py`.
2. **Annotate masks** once in the `max` projection (Cellpose GUI).
3. **Reuse the masks** for `mean`/`median`:
   ```
   python cellpose_organoid/copy_max_masks.py \
     --base-path /Volumes/Manny4TBUM/10_16_2025/lhx6_pdch19_WTvsKO_projectfolder \
     --analysis PCDHvsLHX6_WTvsKO_IHC --include-png
   ```
4. **Run the analysis** (repeat for max/mean/median as needed, using a new
   `--run-tag` each time):
   ```
   python cellpose_organoid/analyse_whole_organoid.py \
     --base-path /Volumes/Manny4TBUM/10_16_2025/lhx6_pdch19_WTvsKO_projectfolder \
     --analysis PCDHvsLHX6_WTvsKO_IHC \
     --projection max \
     --run-tag LHX6_max_run1
   ```

Output folders live under
`analysis_results/<analysis>/whole_organoid_analysis/analysis_pipeline/<channel>/runs/<run-tag>/`.

---

## Typical Training Workflow

1. **Edit `train_organoid_model.sh`**  
   Update these variables so they match your project drive:
   - `PROJECT_ROOT` – path to `cellprofilerandcellpose_folder`
   - `ANALYSIS`, `PROJECTION_TYPES`, `EXPERIMENT_GROUPS`, optional `CHANNEL_SLUGS`

2. **Run the training script**
   ```bash
   conda activate cellprofiler_env
   bash cellpose_organoid/train_organoid_model.sh
   ```
   The script creates a separate workspace next to the project data:
   ```
   <project>/cellpose_organoid_workspace/
     ├── data/train/          # symlinks to TIFFs from the metadata
     ├── logs/                # training logs (tee output)
     └── models/              # archived checkpoints
   ```

3. **Use the trained model**
   - Point `make_seg_from_model.py` at any directories that contain TIFFs.
   - Pass `--model` with either a Cellpose preset (e.g. `cyto3`) or a custom
     model folder exported by the training script.

### Manual mask creation (Cellpose GUI)

If you prefer to draw or verify masks manually, launch the Cellpose GUI from the
same `cellprofiler_env` environment:

```bash
conda activate cellprofiler_env
cellpose
```

Open the `WT` and `KO` folders under  
`<project>/cellpose_multichannel_zcyx/<analysis>/<projection>/`, set the diameter
to **1500**, `flow_threshold` to **0.1**, and `cellprob_threshold` to **-0.6`,
then save the results. The GUI writes the standard
`*_seg.npy`, `*_cp_masks.png`, and flow files next to each image in place. When
these exist, the automation in Step 2 recognises them and skips re-generating
labels, so the manual masks take precedence.

### Analyse manual whole-organoid masks

Once the GUI has saved `_seg.npy` files, recreate the WT vs KO summary tables
and plots with:

```bash
conda activate organoid_roi_incucyte_imaging
python cellpose_organoid/analyse_whole_organoid.py \
  --base-path /Volumes/Manny4TBUM/10_16_2025/lhx6_pdch19_WTvsKO_projectfolder \
  --analysis PCDHvsLHX6_WTvsKO_IHC \
  --projection max \
  --run-tag PCDH19_max_v1
```

Outputs are stored in
`<base>/analysis_results/<analysis>/whole_organoid_analysis/analysis_pipeline/`
with the same per-channel CSVs and summary figures used elsewhere in the
project, plus per-group masked-intensity panels (WT and KO) so you can visually
inspect the pixels each mask captures. Combined WT vs KO panels use the WT
intensity distribution (1st–99th percentile) to set the shared color scale,
making between-group changes obvious.

Each run is written to `analysis_pipeline/<channel>/runs/<run-tag>/...`. If you
omit `--run-tag` a timestamp is used so repeated analyses do not overwrite prior
CSVs/figures. The symlink `analysis_pipeline/<channel>/latest` always points to
the most recent run for convenience.

If you want to reuse the same ROI for the `mean` or `median` projections, run
the helper after saving masks in the `max` folder:

```bash
python cellpose_organoid/copy_max_masks.py \
  --base-path /path/to/project \
  --analysis YOUR_ANALYSIS_NAME \
  --include-png
```

This duplicates each `_seg.npy` (and optional `_cp_masks.png`) into the sibling
projection directories with the correct naming convention, so
`analyse_whole_organoid.py` can process all projection types using the same ROI.

Examples:

```
# PCDHvsLHX6_WTvsKO_IHC (10_16_2025)
python cellpose_organoid/analyse_whole_organoid.py \
  --base-path /Volumes/Manny4TBUM/10_16_2025/lhx6_pdch19_WTvsKO_projectfolder \
  --analysis PCDHvsLHX6_WTvsKO_IHC \
  --projection max \
  --run-tag LHX6_max_run1

python cellpose_organoid/analyse_whole_organoid.py \
  --base-path /Volumes/Manny4TBUM/10_16_2025/lhx6_pdch19_WTvsKO_projectfolder \
  --analysis PCDHvsLHX6_WTvsKO_IHC \
  --projection mean \
  --run-tag LHX6_mean_run1

python cellpose_organoid/analyse_whole_organoid.py \
  --base-path /Volumes/Manny4TBUM/10_16_2025/lhx6_pdch19_WTvsKO_projectfolder \
  --analysis PCDHvsLHX6_WTvsKO_IHC \
  --projection median \
  --run-tag LHX6_median_run1

# NestinvsDcx_WTvsKO_IHC (10_13_2025)
python cellpose_organoid/analyse_whole_organoid.py \
  --base-path /Volumes/Manny4TBUM/10_13_2025/nestin_dcx_pcdh19_kovswt \
  --analysis NestinvsDcx_WTvsKO_IHC \
  --projection max \
  --run-tag Nestin_max_run1

python cellpose_organoid/analyse_whole_organoid.py \
  --base-path /Volumes/Manny4TBUM/10_13_2025/nestin_dcx_pcdh19_kovswt \
  --analysis NestinvsDcx_WTvsKO_IHC \
  --projection mean \
  --run-tag Nestin_mean_run1

python cellpose_organoid/analyse_whole_organoid.py \
  --base-path /Volumes/Manny4TBUM/10_13_2025/nestin_dcx_pcdh19_kovswt \
  --analysis NestinvsDcx_WTvsKO_IHC \
  --projection median \
  --run-tag Nestin_median_run1
```

Example commands:

```
# Project: PCDHvsLHX6_WTvsKO_IHC (10_16_2025)
python cellpose_organoid/copy_max_masks.py \
  --base-path /Volumes/Manny4TBUM/10_16_2025/lhx6_pdch19_WTvsKO_projectfolder \
  --analysis PCDHvsLHX6_WTvsKO_IHC --include-png

# Project: NestinvsDcx_WTvsKO_IHC (10_13_2025)
python cellpose_organoid/copy_max_masks.py \
  --base-path /Volumes/Manny4TBUM/10_13_2025/nestin_dcx_pcdh19_kovswt \
  --analysis NestinvsDcx_WTvsKO_IHC --include-png
```

Need to reuse the same ROI across `mean`/`median` projections? Copy the masks
from `max` once:

```bash
python cellpose_organoid/copy_max_masks.py \
  --base-path /Volumes/.../your_project \
  --analysis NestinvsDcx_WTvsKO_IHC
```

This duplicates `*_seg.npy` (and optionally `*_cp_masks.png` with
`--include-png`) into the sibling `mean/` and `median/` folders, so
`analyse_whole_organoid.py` can crunch all projection types without redrawing
ROIs.

## Running Just the Helpers

Link training data manually (great for smoke tests):
```bash
python cellpose_organoid/scripts/prepare_training_from_metadata.py \
  --metadata /path/to/cellpose_multichannel_metadata.csv \
  --output /path/to/workspace/data/train \
  --analysis PCDHvsLHX6_WTvsKO_IHC \
  --projection max \
  --group WT --group KO
```

Generate segmentations for a folder:
```bash
python cellpose_organoid/scripts/make_seg_from_model.py \
  --dirs /path/to/workspace/data/train \
  --model cyto3 \
  --diameter 1500
```

Both commands print detailed progress and timings so you can track what the
pipeline is doing.

---

## Housekeeping

- The workspace folder can be deleted and recreated safely; the scripts only
  create symlinks and new outputs.
- Training logs are timestamped, so you can keep multiple runs if desired.
- The git repository stays clean because no training artifacts are written
  under `cellpose_organoid/`.
